pool:
  name: $(pool_name)
  vmImage: 'ubuntu-latest'
steps:
  - task: NodeTool@0
    displayName: Node install
    inputs: { versionSpec: '10.x' }
  - script: npm install -g npm@latest
    displayName: update NPM
  - task: Npm@1
    displayName: NPM install
    inputs: { command: 'install' }
  - script: npm run all
    displayName: NPM run all
  - script: >-
      rm -rf gh-pages &&
      git submodule add --force https://$(github_access_token)@github.com/DevSnicket/Eunice.git gh-pages &&
      rm -rf gh-pages/dogfooding &&
      cp -r dogfooding/output gh-pages/dogfooding &&
      mkdir -p gh-pages/javascript &&
      rm -rf gh-pages/javascript/harness &&
      cp -r harness/output gh-pages/javascript/harness &&
      rm gh-pages/javascript/harness/harness.js.map &&
      cd gh-pages &&
      git add . &&
      git config --add user.email grahamdyson@hotmail.com &&
      git config --add user.name "JavaScript harness GitHub pages publish" &&
      if [[ `git status --porcelain` ]]; then
        git commit -m "dogfooding and JavaScript harness";
        git push;
      fi
    displayName: GitHub pages publish
  - task: Npm@1
    continueOnError: true
    displayName: NPM publish
    inputs:
      command: 'publish'
      publishEndpoint: 'npm.org registry'
trigger: [ master ]
workspace: { clean: all }